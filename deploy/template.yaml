AWSTemplateFormatVersion: "2010-09-09"

Description: >-
  This creates the necessary components to deploy IPV Core Front onto ECS
  Fargate within an existing VPC and private subnets (provided as parameters).
  Core Front can be invoked via the public API Gateway on the url in the
  CoreFrontUrl output.

  The ingress route in summary is: API Gateway -> VPC link -> private ALB ->
  Core Front ECS Service

  Core Front egress to Core Back's API Gateway is via a NAT Gateway, not created
  here, which should have a route in the provided private subnets' route table.

Parameters:
  Environment:
    Description: The name of the environment to deploy to.
    Type: String
    AllowedPattern: ((production)|(integration)|(staging)|(build)|(dev.*))
  VpcStackName:
    Description: >
      The name of the stack that defines the VPC in which this container will
      run.
    Type: String
  PermissionsBoundary:
    Description: "The ARN of the permissions boundary to apply when creating IAM roles"
    Type: String
    Default: "none"
  CodeSigningConfigArn:
    Type: String
    Description: Asserts that lambdas are signed when deployed.
    Default: "none"
  DeploymentStrategy:
    Description: "Predefined deployment configuration for ECS application"
    Type: String
    Default: "None"
    # Allowed values: See https://docs.aws.amazon.com/codedeploy/latest/userguide/deployment-configurations.html
    AllowedValues:
      - None
      - CodeDeployDefault.ECSCanary10Percent5Minutes
      - CodeDeployDefault.ECSCanary10Percent15Minutes
      - CodeDeployDefault.ECSAllAtOnce

Conditions:
  IsDevelopment: !Or
    - !Equals [ !Ref AWS::AccountId, "130355686670"]
    - !Equals [ !Ref AWS::AccountId, "175872367215"]
  IsDev01: !Equals [ !Ref AWS::AccountId, "130355686670"]
  IsDev02: !Equals [ !Ref AWS::AccountId, "175872367215"]
  IsBuild: !Equals [ !Ref AWS::AccountId, "457601271792"]
  IsNotDevelopment: !Not [ !Condition IsDevelopment ]
  IsProduction: !Equals [ !Ref Environment, production ]
  IsSubscriptionEnviroment: !Or
    - !Equals [ !Ref Environment, staging ]
    - !Equals [ !Ref Environment, integration ]
    - !Equals [ !Ref Environment, production ]
  UsePermissionsBoundary: !Not
    - !Equals [ !Ref PermissionsBoundary, "none" ]
  UseCodeSigning: !Not
    - !Equals [ !Ref CodeSigningConfigArn, "none" ]
  UseCanaryDeployment: !Or
    - !Condition IsNotDevelopment
    - !Equals [ !Ref Environment, dev-canary ]

# The AWS Account Id is used in the following mapping section because we have
# multiple developer environments and it is undesirable to have to keep this
# mapping up to date with each developer environment.
Mappings:
  EnvironmentConfiguration:
    "130355686670": # core-dev01
      lb400ErrorLimit: 10
      lb500ErrorLimit: 2
      lb500ErrorWindow: 300
      tg500ErrorLimit: 10
      tg500ErrorWindow: 300
      lambdaInvokeCompareWindow: 300
      fargateCPUsize: "256"
      fargateRAMsize: "512"
      nodeOldSpaceLimit: "384"
      nodeEnv: "development"
      desiredTaskCount: 1
      ga4Disabled: false
      uaDisabled: false
      assetsDomain: ""
      assetsPath: ""
      contactUrl: "https://home.build.account.gov.uk/contact-gov-uk-one-login"
      templateCaching: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      spotAccountArn: arn:aws:iam::738810260032:root
    "175872367215": # core-dev02
      lb400ErrorLimit: 10
      lb500ErrorLimit: 2
      lb500ErrorWindow: 300
      tg500ErrorLimit: 10
      tg500ErrorWindow: 300
      lambdaInvokeCompareWindow: 300
      fargateCPUsize: "256"
      fargateRAMsize: "512"
      nodeOldSpaceLimit: "384"
      nodeEnv: "development"
      desiredTaskCount: 1
      ga4Disabled: false
      uaDisabled: false
      assetsDomain: ""
      assetsPath: ""
      contactUrl: "https://home.build.account.gov.uk/contact-gov-uk-one-login"
      templateCaching: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      spotAccountArn: arn:aws:iam::738810260032:root
    "457601271792": # Build
      lb400ErrorLimit: 10
      lb500ErrorLimit: 2
      lb500ErrorWindow: 300
      tg500ErrorLimit: 10
      tg500ErrorWindow: 300
      lambdaInvokeCompareWindow: 300
      #fargateCPUsize: "2048"
      #fargateRAMsize: "4096"
      #nodeOldSpaceLimit: "3792"
      #desiredTaskCount: 2
      fargateCPUsize: "1024"
      fargateRAMsize: "2048"
      nodeOldSpaceLimit: "1896"
      nodeEnv: "production"
      desiredTaskCount: 2
      ga4Disabled: false
      uaDisabled: false
      assetsDomain: "https://assets.build.account.gov.uk"
      assetsPath: "https://assets.build.account.gov.uk/core-front"
      contactUrl: "https://home.build.account.gov.uk/contact-gov-uk-one-login"
      templateCaching: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      spotAccountArn: arn:aws:iam::429671060046:root
    "335257547869": # Staging
      lb400ErrorLimit: 10
      lb500ErrorLimit: 2
      lb500ErrorWindow: 300
      tg500ErrorLimit: 10
      tg500ErrorWindow: 300
      lambdaInvokeCompareWindow: 300
      fargateCPUsize: "256"
      fargateRAMsize: "512"
      nodeOldSpaceLimit: "256"
      nodeEnv: "production"
      desiredTaskCount: 1
      ga4Disabled: false
      uaDisabled: false
      assetsDomain: "https://assets.staging.account.gov.uk"
      assetsPath: "https://assets.staging.account.gov.uk/core-front"
      contactUrl: "https://home.staging.account.gov.uk/contact-gov-uk-one-login"
      templateCaching: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      spotAccountArn: arn:aws:iam::444977453444:root
    "991138514218": # Integration
      lb400ErrorLimit: 10
      lb500ErrorLimit: 2
      lb500ErrorWindow: 300
      tg500ErrorLimit: 10
      tg500ErrorWindow: 300
      lambdaInvokeCompareWindow: 300
      fargateCPUsize: "512"
      fargateRAMsize: "1024"
      nodeOldSpaceLimit: "768"
      nodeEnv: "production"
      desiredTaskCount: 1
      ga4Disabled: true
      uaDisabled: false
      assetsDomain: "https://assets.integration.account.gov.uk"
      assetsPath: "https://assets.integration.account.gov.uk/core-front"
      contactUrl: "https://home.integration.account.gov.uk/contact-gov-uk-one-login"
      templateCaching: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables
      spotAccountArn: arn:aws:iam::298945768017:root
    "075701497069": # Production
      lb400ErrorLimit: 20
      lb500ErrorLimit: 2
      lb500ErrorWindow: 300
      tg500ErrorLimit: 50
      tg500ErrorWindow: 300
      lambdaInvokeCompareWindow: 300
      fargateCPUsize: "1024"
      fargateRAMsize: "2048"
      nodeOldSpaceLimit: "1792"
      nodeEnv: "production"
      desiredTaskCount: 2
      ga4Disabled: true
      uaDisabled: false
      assetsDomain: ""
      assetsPath: ""
      contactUrl: "https://home.account.gov.uk/contact-gov-uk-one-login"
      templateCaching: true
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables
      spotAccountArn: arn:aws:iam::101836073728:root
  SecurityGroups:
    PrefixListIds:
      dynamodb: "pl-b3a742da"
      s3: "pl-7ca54015"

Resources:

  # ssl cert
  DevSSLCert:
    Type: AWS::CertificateManager::Certificate
    Condition: IsDevelopment
    Properties:
      DomainName: !If
        - IsDev01
        - !Sub "${Environment}.01.dev.identity.account.gov.uk"
        - !If [IsDev02, !Sub "${Environment}.02.dev.identity.account.gov.uk", !Ref AWS::NoValue]
      DomainValidationOptions:
        - DomainName: !If
            - IsDev01
            - !Sub "${Environment}.01.dev.identity.account.gov.uk"
            - !If [IsDev02, !Sub "${Environment}.02.dev.identity.account.gov.uk", !Ref AWS::NoValue]
          HostedZoneId: !If
            - IsDev01
            - !ImportValue Dev01IdentityHostedZoneId
            - !If [IsDev02, !ImportValue Dev02IdentityHostedZoneId, DevIdentityHostedZoneId]
      ValidationMethod: DNS

  # api domain entries / mapping (intentionally V2 as needs to be that way for prod)
  DevApiDomain:
    Type: AWS::ApiGatewayV2::DomainName
    Condition: IsDevelopment
    Properties:
      DomainName: !If
        - IsDev01
        - !Sub "${Environment}.01.dev.identity.account.gov.uk"
        - !If [IsDev02, !Sub "${Environment}.02.dev.identity.account.gov.uk", !Ref AWS::NoValue]
      DomainNameConfigurations:
        - CertificateArn: !Ref DevSSLCert
          EndpointType: REGIONAL
          SecurityPolicy: TLS_1_2

  DevApiMapping:
    Type: AWS::ApiGatewayV2::ApiMapping
    Condition: IsDevelopment
    DependsOn: RestApiGwDeployment
    Properties:
      DomainName: !Ref DevApiDomain
      ApiId: !Ref RestApiGateway
      Stage: !Ref ApiGatewayStage


  # dns rcord
  DevDNSRecord:
    Type: AWS::Route53::RecordSet
    Condition: IsDevelopment
    Properties:
      Type: A
      Name: !Ref DevApiDomain
      HostedZoneId: !If
          - IsDev01
          - !ImportValue Dev01IdentityHostedZoneId
          - !If [IsDev02, !ImportValue Dev02IdentityHostedZoneId, DevIdentityHostedZoneId]
      AliasTarget:
        DNSName: !GetAtt DevApiDomain.RegionalDomainName
        HostedZoneId: !GetAtt DevApiDomain.RegionalHostedZoneId

 # Security Groups for the ECS service and load balancer
  PrivateLoadBalancerSG:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: >-
        Core Front LoadBalancer Security Group
      SecurityGroupIngress:
        - CidrIp:
            Fn::ImportValue: !Sub ${VpcStackName}-VpcCidr
          Description: Allow vpc cidr ingress to port 80
          FromPort: 80
          IpProtocol: tcp
          ToPort: 80
      VpcId:
        Fn::ImportValue: !Sub ${VpcStackName}-VpcId

  PrivateLoadBalancerSGEgressToECSSecurityGroup:
    Type: "AWS::EC2::SecurityGroupEgress"
    Properties:
      GroupId: !GetAtt PrivateLoadBalancerSG.GroupId
      IpProtocol: tcp
      Description: >-
        Egress between the Core Front load balancer and
        the core front ECS security group
      DestinationSecurityGroupId: !GetAtt CoreFrontECSSecurityGroup.GroupId
      FromPort: 8080
      ToPort: 8080

  CoreFrontECSSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupDescription: >-
        Core Front ECS Security Group outbound permissions ruleset
      SecurityGroupEgress:
        - DestinationPrefixListId: !FindInMap [SecurityGroups, PrefixListIds, dynamodb]
          Description: Allow outbound traffic to dynamodb vpc endpoint
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
        - DestinationPrefixListId: !FindInMap [SecurityGroups, PrefixListIds, s3]
          Description: Allow outbound traffic to s3 vpc endpoint
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
        - DestinationSecurityGroupId:
            Fn::ImportValue:  !Sub ${VpcStackName}-AWSServicesEndpointSecurityGroupId
          Description: Allow outbound traffic to AWS Services vpc endpoint security group
          IpProtocol: tcp
          FromPort: 443
          ToPort: 443
      SecurityGroupIngress:
        - CidrIp:
            Fn::ImportValue: !Sub ${VpcStackName}-VpcCidr
          Description: Allow inbound traffic from vpc cidr to port 443
          FromPort: 443
          IpProtocol: tcp
          ToPort: 443
      VpcId:
        Fn::ImportValue: !Sub ${VpcStackName}-VpcId

  CoreFrontECSSecurityGroupIngressFromLoadBalancer:
    Type: "AWS::EC2::SecurityGroupIngress"
    Properties:
      IpProtocol: tcp
      Description: >-
        Core Front ECS permits inbound from the Core Front
        load balancer.
      FromPort: 8080
      ToPort: 8080
      GroupId: !GetAtt CoreFrontECSSecurityGroup.GroupId
      SourceSecurityGroupId: !GetAtt PrivateLoadBalancerSG.GroupId

  AccessLogsBucket:
    Type: AWS::S3::Bucket
    #checkov:skip=CKV_AWS_18: This is the bucket where our access logs go and AWS advise not sending a bucket's access logs to itself.
    Properties:
      BucketName: !If
        - IsDevelopment # existing bucket names exist in the current dev env
        - !Sub ipv-core-access-logs-${Environment}
        - !Sub ipv-core-${Environment}-access-logs
      AccessControl: LogDeliveryWrite
      VersioningConfiguration:
        Status: "Enabled"
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

  SpotKeysS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub published-did-documents-${Environment}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              KMSMasterKeyID: !GetAtt S3KmsKey.Arn
              SSEAlgorithm: "aws:kms"
      VersioningConfiguration:
        Status: "Enabled"
      LoggingConfiguration:
        DestinationBucketName: !Ref AccessLogsBucket
        LogFilePrefix: spot-signing-keys
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: true
        BlockPublicPolicy: true
        RestrictPublicBuckets: true

  SpotKeysBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SpotKeysS3Bucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowAccountAccess
            Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - "s3:*"
            Resource: !Sub "arn:aws:s3:::${SpotKeysS3Bucket}/*"
          - Sid: AllowSpotAccountAccess
            Effect: Allow
            Principal:
              AWS: !FindInMap
                - EnvironmentConfiguration
                - !Ref AWS::AccountId
                - spotAccountArn
            Action:
              - "s3:PutObject"
              - "s3:GetObject"
            Resource: !Sub "arn:aws:s3:::${SpotKeysS3Bucket}/*"

  CoreFrontAccessLogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AccessLogsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - arn:aws:iam::652711504416:root
            Action:
              - s3:PutObject
            Resource:
              - !Sub arn:aws:s3:::${AccessLogsBucket}/core-front-${Environment}/AWSLogs/${AWS::AccountId}/*
          - Effect: Allow
            Principal:
              Service: logging.s3.amazonaws.com
            Action: s3:PutObject
            Resource: !Sub "arn:aws:s3:::${AccessLogsBucket}/*"
            Condition:
              StringEquals:
                "aws:SourceAccount": !Sub "${AWS::AccountId}"
          - Effect: Deny
            Resource:
              - !GetAtt AccessLogsBucket.Arn
              - !Sub "${AccessLogsBucket.Arn}/*"
            Principal: "*"
            Action:
              - "s3:*"
            Condition:
              Bool:
                "aws:SecureTransport": false
              NumericLessThan:
                "s3:TlsVersion": "1.2"

  # Private Application Load Balancer
  PrivateLoadBalancer:
    Type: "AWS::ElasticLoadBalancingV2::LoadBalancer"
    Properties:
      Scheme: internal
      SecurityGroups:
        - !GetAtt PrivateLoadBalancerSG.GroupId
      Subnets:
        - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdA
        - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdB
      Type: application
      #checkov:skip=CKV_AWS_91:ALB access logging is disabled in developer environments to make them easier to manage.
      LoadBalancerAttributes:
        - Key: routing.http.drop_invalid_header_fields.enabled
          Value: true
        - !If
          - IsNotDevelopment
          - Key: access_logs.s3.enabled
            Value: true
          - !Ref AWS::NoValue
        - !If
          - IsNotDevelopment
          - Key: access_logs.s3.bucket
            Value: !Ref AccessLogsBucket
          - !Ref AWS::NoValue
        - !If
          - IsNotDevelopment
          - Key: access_logs.s3.prefix
            Value: !Sub core-front-${Environment}
          - !Ref AWS::NoValue
        - !If
          - IsNotDevelopment
          - Key: deletion_protection.enabled
            Value: true
          - !Ref AWS::NoValue
    DependsOn: CoreFrontAccessLogsBucketPolicy

  PrivateLoadBalancerListenerTargetGroupECS:
    Type: "AWS::ElasticLoadBalancingV2::TargetGroup"
    Properties:
      HealthCheckEnabled: TRUE
      HealthCheckProtocol: HTTP
      HealthCheckPath: /healthcheck
      HealthCheckTimeoutSeconds: 14
      HealthCheckIntervalSeconds: 15
      HealthyThresholdCount: 2
      Matcher:
        HttpCode: 200
      Port: 80
      Protocol: HTTP
      TargetType: ip
      VpcId:
        Fn::ImportValue: !Sub ${VpcStackName}-VpcId
      TargetGroupAttributes:
        - Key: deregistration_delay.timeout_seconds
          Value: 30



  PrivateLoadBalancerListener:
    Type: "AWS::ElasticLoadBalancingV2::Listener"
    Properties:
      # checkov:skip=CKV_AWS_2:Certificate generation must be resolved before the listener can use HTTPS.
      # checkov:skip=CKV_AWS_103:The load balancer cannot use TLS v1.2 until HTTPS is enabled
      DefaultActions:
        - TargetGroupArn: !Ref PrivateLoadBalancerListenerTargetGroupECS
          Type: forward
      LoadBalancerArn: !Ref PrivateLoadBalancer
      Port: 80
      Protocol: HTTP

  # ECS cluster, service and task definition
  CoreFrontCluster:
    Type: "AWS::ECS::Cluster"
    Properties:
      ClusterSettings:
        - Name: containerInsights
          Value: enabled

  CoreFrontService:
    Type: "AWS::ECS::Service"
    Properties:
      Cluster: !Ref CoreFrontCluster
      DeploymentConfiguration: !If
        - UseCanaryDeployment
        - !Ref AWS::NoValue
        - MaximumPercent: 500
          MinimumHealthyPercent: 50
          DeploymentCircuitBreaker:
            Enable: true
            Rollback: true
      DeploymentController:
        Type: !If
          - UseCanaryDeployment
          - CODE_DEPLOY
          - ECS
      DesiredCount: !FindInMap
        - EnvironmentConfiguration
        - !Ref AWS::AccountId
        - desiredTaskCount
      EnableECSManagedTags: false
      HealthCheckGracePeriodSeconds: 45
      LaunchType: FARGATE
      LoadBalancers:
        - ContainerName: app
          ContainerPort: 8080
          TargetGroupArn: !Ref PrivateLoadBalancerListenerTargetGroupECS
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !GetAtt CoreFrontECSSecurityGroup.GroupId
          Subnets:
            - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdA
            - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdB
      TaskDefinition: !If
        - UseCanaryDeployment
        - !Ref AWS::NoValue
        - !Ref ECSServiceTaskDefinition
    DependsOn:
      - PrivateLoadBalancerListener

  CoreFrontAutoScalingTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: 60
      MinCapacity: 2
      ResourceId: !Join
        - '/'
        - - "service"
          - !Ref CoreFrontCluster
          - !GetAtt CoreFrontService.Name
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  CoreFrontAutoScalingPolicy:
    DependsOn: CoreFrontAutoScalingTarget
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: CoreFrontAutoScalingPolicy
      PolicyType: TargetTrackingScaling
      ResourceId: !Join
        - '/'
        - - "service"
          - !Ref CoreFrontCluster
          - !GetAtt CoreFrontService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        TargetValue: 45
        ScaleInCooldown: 420
        ScaleOutCooldown: 60

  CoreFrontStepScaleOutPolicy:
    DependsOn: CoreFrontAutoScalingTarget
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: CoreFrontStepScalingOutPolicy
      PolicyType: StepScaling
      ResourceId: !Join
        - '/'
        - - "service"
          - !Ref CoreFrontCluster
          - !GetAtt CoreFrontService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      StepScalingPolicyConfiguration:
        AdjustmentType: PercentChangeInCapacity
        Cooldown: 120
        MinAdjustmentMagnitude: 5
        StepAdjustments:
          - MetricIntervalLowerBound: 20
            MetricIntervalUpperBound: 30
            ScalingAdjustment: 200
          - MetricIntervalLowerBound: 30
            MetricIntervalUpperBound: 35
            ScalingAdjustment: 300
          - MetricIntervalLowerBound: 35
            ScalingAdjustment: 500

  CoreFrontStepScaleInPolicy:
    DependsOn: CoreFrontAutoScalingTarget
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: CoreFrontStepScalingInPolicy
      PolicyType: StepScaling
      ResourceId: !Join
        - '/'
        - - "service"
          - !Ref CoreFrontCluster
          - !GetAtt CoreFrontService.Name
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs
      StepScalingPolicyConfiguration:
        AdjustmentType: PercentChangeInCapacity
        Cooldown: 420
        StepAdjustments:
          - MetricIntervalUpperBound: -40
            ScalingAdjustment: -50

  CoreFrontStepScaleOutAlarm:
    DependsOn: CoreFrontAutoScalingTarget
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref CoreFrontStepScaleOutPolicy
      AlarmDescription: "CoreFrontClusterOver60PercentCPU"
      ComparisonOperator: "GreaterThanThreshold"
      DatapointsToAlarm: "2"
      Dimensions:
        - Name: ClusterName
          Value: !Ref CoreFrontCluster
        - Name: ServiceName
          Value: !GetAtt CoreFrontService.Name
      Unit: "Percent"
      EvaluationPeriods: "2"
      MetricName: "CPUUtilization"
      Namespace: "AWS/ECS"
      Statistic: "Average"
      Period: "60"
      Threshold: "60"

  CoreFrontStepScaleInAlarm:
    DependsOn: CoreFrontAutoScalingTarget
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Ref CoreFrontStepScaleInPolicy
      AlarmDescription: "CoreFrontClusterUnder60PercentCPU"
      ComparisonOperator: "LessThanThreshold"
      DatapointsToAlarm: "5"
      Dimensions:
        - Name: ClusterName
          Value: !Ref CoreFrontCluster
        - Name: ServiceName
          Value: !GetAtt CoreFrontService.Name
      Unit: "Percent"
      EvaluationPeriods: "5"
      MetricName: "CPUUtilization"
      Namespace: "AWS/ECS"
      Statistic: "Average"
      Period: "60"
      Threshold: "60"


  ECSAccessLogsGroup:
    Type: AWS::Logs::LogGroup
    # checkov:skip=CKV_AWS_158: No need for customer managed keys for short lived logs
    Properties:
      LogGroupName: !Sub /aws/ecs/${AWS::StackName}-CoreFront-ECS
      RetentionInDays: 30

  ECSAccessLogsGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsSubscriptionEnviroment
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref ECSAccessLogsGroup

  ECSServiceTaskDefinition:
    Type: "AWS::ECS::TaskDefinition"
    Properties:
      ContainerDefinitions:
        - Essential: true
          Image: CONTAINER-IMAGE-PLACEHOLDER
          Name: app
          Environment:
            - Name: API_BASE_URL
              Value: !Sub
                - "https://${APIGatewayId}.execute-api.eu-west-2.amazonaws.com/${Environment}"
                - APIGatewayId:
                    Fn::ImportValue: !Sub IPVCorePrivateAPIGatewayID-${Environment}
                  Environment: !Ref Environment
            - Name: APP_STORE_URL_ANDROID
              Value: "https://play.google.com/store/apps/details?id=uk.gov.documentchecking"
            - Name: APP_STORE_URL_APPLE
              Value: "https://apps.apple.com/gb/app/gov-uk-id-check/id1629050566"
            - Name: SESSION_TABLE_NAME
              Value: !Sub
                - "core-front-sessions-${Environment}"
                - Environment: !Ref Environment
            - Name: ENABLE_PREVIEW
              Value: !If
                - IsBuild
                - "development"
                - !If [IsDevelopment, "development", !Ref AWS::NoValue]
            - Name: EXTERNAL_WEBSITE_HOST
              Value: !GetAtt ApiGwHttpEndpoint.ApiEndpoint
            - Name: GTM_ID
              Value: !If [ IsProduction, "GTM-TT5HDKV", "GTM-TK92W68" ]
            - Name: GTM_ID_GA4
              Value: !If [ IsProduction, "GTM-K4PBJH3", "GTM-KD86CMZ" ]
            - Name: ANALYTICS_DOMAIN
              Value: !If
                - IsProduction
                - "account.gov.uk"
                - !If
                  - IsDev01
                  - !Sub "${Environment}.01.dev.identity.account.gov.uk"
                  - !If [IsDev02, !Sub "${Environment}.02.dev.identity.account.gov.uk", !Sub "${Environment}.account.gov.uk"]
            - Name: SERVICE_DOMAIN
              Value: !If
                - IsProduction
                - "account.gov.uk"
                - !If
                  - IsDev01
                  - !Sub "${Environment}.01.dev.identity.account.gov.uk"
                  - !If [IsDev02, !Sub "${Environment}.02.dev.identity.account.gov.uk", !Sub "${Environment}.account.gov.uk"]
            - Name: SERVICE_URL
              Value: !If
                - IsProduction
                - "https://identity.account.gov.uk"
                - !If
                  - IsDev01
                  - !Sub "https://${Environment}.01.dev.identity.account.gov.uk"
                  - !If [IsDev02, !Sub "https://${Environment}.02.dev.identity.account.gov.uk", !Sub "https://identity.${Environment}.account.gov.uk"]
            - Name: SESSION_SECRET
              Value: "no-secret"
            - Name: LANGUAGE_TOGGLE
              Value: false
            - Name: NODE_OPTIONS
              Value: !Join
                - ''
                - - '--max-old-space-size='
                  - !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, nodeOldSpaceLimit ]
            - Name: NODE_ENV
              Value: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, nodeEnv ]
            - Name: RUM_APPLICATION_ID
              Value: !If [ IsNotDevelopment,
                  Fn::ImportValue: !Sub "AppMonitorId-${Environment}",
                  ""]
            - Name: RUM_ROLE_ARN
              Value: !If [ IsNotDevelopment,
                  Fn::ImportValue: !Sub "CognitoRoleARN-${Environment}",
                  "" ]
            - Name: RUM_COGNITO_POOL
              Value: !If [ IsNotDevelopment,
                  Fn::ImportValue: !Sub "CognitoPoolID-${Environment}",
                  "" ]
            - Name: GA4_DISABLED
              Value: !FindInMap
                - EnvironmentConfiguration
                - !Ref AWS::AccountId
                - ga4Disabled
            - Name: UA_DISABLED
              Value: !FindInMap
                - EnvironmentConfiguration
                - !Ref AWS::AccountId
                - uaDisabled
            - Name: CDN_PATH
              Value: !FindInMap
                - EnvironmentConfiguration
                - !Ref AWS::AccountId
                - assetsPath
            - Name: CDN_DOMAIN
              Value: !FindInMap
                - EnvironmentConfiguration
                - !Ref AWS::AccountId
                - assetsDomain
            - Name: CONTACT_URL
              Value: !FindInMap
                - EnvironmentConfiguration
                - !Ref AWS::AccountId
                - contactUrl
            - Name: TEMPLATE_CACHING
              Value: !FindInMap
                - EnvironmentConfiguration
                - !Ref AWS::AccountId
                - templateCaching
          Secrets:
            - Name: DT_TENANT
              ValueFrom: !Join
                - ''
                - - !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, dynatraceSecretArn ]
                  - ':DT_TENANT::'
            - Name: DT_TENANTTOKEN
              ValueFrom: !Join
                - ''
                - - !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, dynatraceSecretArn ]
                  - ':DT_TENANTTOKEN::'
            - Name: DT_CONNECTION_POINT
              ValueFrom: !Join
              - ''
              - - !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, dynatraceSecretArn ]
                - ':DT_CONNECTION_POINT::'
          PortMappings:
            - ContainerPort: 8080
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref ECSAccessLogsGroup
              awslogs-region: !Sub ${AWS::Region}
              awslogs-stream-prefix: !Sub core-front-${Environment}
      Cpu: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, fargateCPUsize ]
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      Memory: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, fargateRAMsize ]
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      TaskRoleArn: !GetAtt ECSTaskRole.Arn

  ECSTaskExecutionRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      Policies:
        - PolicyName: PullCoreFrontImage
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "ecr:BatchGetImage"
                  - "ecr:GetDownloadUrlForLayer"
                  - "ecr:GetAuthorizationToken"
                Resource:
                  - "*"
              - Effect: Allow
                Action:
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource:
                  - !GetAtt "ECSAccessLogsGroup.Arn"
                  - !Sub "${ECSAccessLogsGroup.Arn}:*"
        - PolicyName: DynatraceGetSecrets
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "secretsmanager:GetSecretValue" #pragma: allowlist secret
                Resource:
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables*"
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables*"
              - Effect: Allow
                Action:
                  - "secretsmanager:ListSecrets" #pragma: allowlist secret
                Resource:
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:*"
              - Effect: Allow
                Action:
                  - "kms:Decrypt"
                Resource:
                  - "arn:aws:kms:eu-west-2:216552277552:key/*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  ECSTaskRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: "sts:AssumeRole"
            Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
        Version: 2012-10-17
      Policies:
        - PolicyName: CoreFrontDynamoDBSessionAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "dynamodb:BatchGetItem"
                  - "dynamodb:DescribeTable"
                  - "dynamodb:GetItem"
                  - "dynamodb:Query"
                  - "dynamodb:Scan"
                  - "dynamodb:BatchWriteItem"
                  - "dynamodb:DeleteItem"
                  - "dynamodb:UpdateItem"
                  - "dynamodb:PutItem"
                Resource:
                  - !GetAtt CoreFrontSessionsTable.Arn
              - Effect: Allow
                Action:
                  - "kms:Decrypt"
                Resource:
                  - !GetAtt DynamoDBKmsKey.Arn
        - PolicyName: DynatraceGetSecrets
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "secretsmanager:GetSecretValue" #pragma: allowlist secret
                Resource:
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables*"
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables*"
              - Effect: Allow
                Action:
                  - "secretsmanager:ListSecrets" #pragma: allowlist secret
                Resource:
                  - "arn:aws:secretsmanager:eu-west-2:216552277552:secret:*"
              - Effect: Allow
                Action:
                  - "kms:Decrypt"
                Resource:
                  - "arn:aws:kms:eu-west-2:216552277552:key/*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue

  #
  # REST API Gateway
  #
  #
  RestApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub ipv-core-front-${Environment}-rest
      DisableExecuteApiEndpoint: true
      EndpointConfiguration:
        Types:
          - REGIONAL

  RestApiGwDeployment:
    DependsOn: RestApiGatewayMethod
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref RestApiGateway

  RestApiGatewayMethod:
    Type: AWS::ApiGateway::Method
    Metadata:
      checkov:
        skip:
          - id: "CKV_AWS_59"
            comment: "API should have AuthorizationType if appropriate - this is intentionally public"
    Properties:
      HttpMethod: ANY
      ResourceId: !Ref RestProxyResource
      RestApiId: !Ref RestApiGateway
      AuthorizationType: NONE
      RequestParameters:
        method.request.path.proxy: false
        method.request.header.x-forwarded-for: false
      Integration:
        Type: HTTP_PROXY
        ConnectionType: VPC_LINK
        ConnectionId: !If
          - IsDevelopment
          - !Ref ApiGatewayVpcLink
          - Fn::ImportValue: !Sub "${VpcStackName}-ApiGatewayVpcLinkId"
        RequestParameters:
          integration.request.path.proxy: "method.request.path.proxy"
          integration.request.header.x-forwarded-for: "method.request.header.x-forwarded-for"
        IntegrationHttpMethod: ANY
        PassthroughBehavior: WHEN_NO_MATCH
        Uri: !Sub
          - "http://${LBDNS}/{proxy}"
          - LBDNS: !If
            - IsDevelopment
            - !GetAtt NetworkLoadBalancer.DNSName
            - Fn::ImportValue: !Sub "${VpcStackName}-ApiGatewayVpcLinkTargetNLBDNS"

  RestProxyResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref RestApiGateway
      ParentId: !GetAtt RestApiGateway.RootResourceId
      PathPart: '{proxy+}'

  ApiGatewayAccessLogGroup:
    Type: AWS::Logs::LogGroup
    # checkov:skip=CKV_AWS_158: No need for customer managed keys for short lived logs
    Properties:
      RetentionInDays: 30
      Tags:
        - Key: Name
          Value: ApiGatewayAccessLogGroup
        - Key: Service
          Value: IPV Core
        - Key: Source
          Value: alphagov/di-ipv-core-front/deploy/template.yaml

  ApiGatewayStage:
    Type: AWS::ApiGateway::Stage
    Metadata:
      checkov:
        skip:
          - id: "CKV_AWS_120"
            comment: "API should have caching - not for our use case"
    Properties:
      StageName: !Sub ${Environment}
      DeploymentId: !Ref RestApiGwDeployment
      RestApiId: !Ref RestApiGateway
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayAccessLogGroup.Arn
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip": "$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path": "$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLength":"$context.responseLength",
          "responseLatency":"$context.responseLatency"
          }
      CacheClusterEnabled: false
      TracingEnabled: true

  #
  # Rest api gateway vpc link
  #

  ApiGatewayVpcLink:
    Condition: IsDevelopment
    DependsOn: NetworkLoadBalancerTargetGroup
    Type: AWS::ApiGateway::VpcLink
    Properties:
      Description: Link from REST API Gateway to NetworkLoadBalancer
      Name: !Sub "${AWS::StackName}-ApiVpcLink"
      TargetArns:
        - !Ref NetworkLoadBalancer

  NetworkLoadBalancer:
    Condition: IsDevelopment
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internal
      Type: network
      Subnets:
        - Fn::ImportValue: !Sub "${VpcStackName}-PrivateSubnetIdA"
        - Fn::ImportValue: !Sub "${VpcStackName}-PrivateSubnetIdB"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-NetworkLoadBalancer"
        - Key: Service
          Value: identity
        - Key: Source
          Value: alphagov/di-ipv-core-front/deploy/template.yaml
    Metadata:
      checkov:
        skip:
          - id: "CKV_AWS_91"
            comment: "ALB access logging is disabled in developer environments to make them easier to manage."

  NetworkLoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref NetworkLoadBalancerTargetGroup
      LoadBalancerArn: !If
        - IsDevelopment
        - !Ref NetworkLoadBalancer
        - Fn::ImportValue: !Sub "${VpcStackName}-ApiGatewayVpcLinkTargetNLB"
      Port: 80
      Protocol: TCP

  NetworkLoadBalancerTargetGroup:
    DependsOn: PrivateLoadBalancerListener
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub "${AWS::StackName}-NLBTarGrp"
      Port: 80
      Protocol: TCP
      Targets:
        - Id: !Ref PrivateLoadBalancer
      TargetType: alb
      HealthCheckEnabled: true
      HealthCheckPath: '/healthcheck'
      VpcId:
        Fn::ImportValue:
          !Sub "${VpcStackName}-VpcId"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-NLBTarGrp"
        - Key: Service
          Value: ci/cd
        - Key: Source
          Value: alphagov/di-ipv-core-front/deploy/template.yaml

  ApiGwHttpEndpoint:
    Type: "AWS::ApiGatewayV2::Api"
    Properties:
      Name: !Sub ipv-core-front-${Environment}
      ProtocolType: HTTP

  ApiGwHttpEndpointIntegration:
    Type: "AWS::ApiGatewayV2::Integration"
    Properties:
      ApiId: !Ref ApiGwHttpEndpoint
      IntegrationType: HTTP_PROXY
      ConnectionId:
        Fn::ImportValue: !Sub "${VpcStackName}-VpcLinkId"
      ConnectionType: VPC_LINK
      IntegrationMethod: ANY
      IntegrationUri: !Ref PrivateLoadBalancerListener
      PayloadFormatVersion: "1.0"

  APIGWRoute:
    Type: "AWS::ApiGatewayV2::Route"
    Properties:
      ApiId: !Ref ApiGwHttpEndpoint
      RouteKey: "ANY /{proxy+}"
      Target: !Join
        - /
        - - integrations
          - !Ref ApiGwHttpEndpointIntegration

  APIStageDefault:
    Type: "AWS::ApiGatewayV2::Stage"
    Properties:
      ApiId: !Ref ApiGwHttpEndpoint
      StageName: $default
      AutoDeploy: true
      AccessLogSettings:
        DestinationArn: !GetAtt APIGWAccessLogsGroup.Arn
        Format: >-
          {
          "requestId":"$context.requestId",
          "ip": "$context.identity.sourceIp",
          "requestTime":"$context.requestTime",
          "httpMethod":"$context.httpMethod",
          "path": "$context.path",
          "routeKey":"$context.routeKey",
          "status":"$context.status",
          "protocol":"$context.protocol",
          "responseLength":"$context.responseLength",
          "responseLatency":"$context.responseLatency"
          }

  APIGWAccessLogsGroup:
    Type: AWS::Logs::LogGroup
    # checkov:skip=CKV_AWS_158: No need for customer managed keys for short lived logs
    Properties:
      LogGroupName: !If
        - IsDevelopment
        - !Sub /aws/vendedlogs/apigateway/${AWS::StackName}-CoreFront-API-GW-AccessLogs
        - !Sub /aws/apigateway/${AWS::StackName}-CoreFront-API-GW-AccessLogs
      RetentionInDays: 30

  APIGWAccessLogsGroupSubscriptionFilter:
    Type: AWS::Logs::SubscriptionFilter
    Condition: IsSubscriptionEnviroment
    Properties:
      DestinationArn: "arn:aws:logs:eu-west-2:885513274347:destination:csls_cw_logs_destination_prodpython"
      FilterPattern: ""
      LogGroupName: !Ref APIGWAccessLogsGroup

  CoreFrontSessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      # checkov:skip=CKV_AWS_28: Point in time recovery is not necessary for this table.
      TableName: !Sub "core-front-sessions-${Environment}"
      BillingMode: "PAY_PER_REQUEST"
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "id"
          KeyType: "HASH"
      TimeToLiveSpecification:
        AttributeName: "expires"
        Enabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
        KMSMasterKeyId: !GetAtt DynamoDBKmsKey.Arn

  LoggingKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"

  DynamoDBKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"

  S3KmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - "kms:*"
            Resource: "*"
          - Effect: Allow
            Principal:
              AWS: !FindInMap
                - EnvironmentConfiguration
                - !Ref AWS::AccountId
                - spotAccountArn
            Action:
              - "kms:GenerateDataKey"
              - "kms:Decrypt*"
            Resource: "*"
            Condition:
              StringEquals:
                kms:ViaService: "s3.amazonaws.com"

  FrontLoadBalancer5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: IsNotDevelopment
    Properties:
      AlarmName: FrontLoadBalancer5xxAlarm
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue sns-topics-AlarmTopic
      OKActions:
        - !ImportValue sns-topics-AlarmTopic
      InsufficientDataActions: []
      EvaluationPeriods: 2
      DatapointsToAlarm: 2
      Threshold: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lb500ErrorLimit ]
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: e1
          Label: Sum-of-5xx-Errors
          ReturnData: true
          Expression: SUM(METRICS())
        - Id: m1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApplicationELB
              MetricName: HTTPCode_ELB_5XX_Count
              Dimensions:
                - Name: LoadBalancer
                  Value: !GetAtt PrivateLoadBalancer.LoadBalancerFullName
            Period: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lb500ErrorWindow ]
            Stat: Sum

  FrontTargetGroup5xxErrors:
    Type: AWS::CloudWatch::Alarm
    Condition: IsNotDevelopment
    Properties:
      AlarmName: FrontTargetGroup5xxAlarm
      ActionsEnabled: true
      AlarmActions:
        - !ImportValue sns-topics-AlarmTopic
      OKActions:
        - !ImportValue sns-topics-AlarmTopic
      InsufficientDataActions: [ ]
      EvaluationPeriods: 2
      DatapointsToAlarm: 2
      Threshold: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, tg500ErrorLimit ]
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: e1
          Label: Sum-of-5xx-Errors
          ReturnData: true
          Expression: SUM(METRICS())
        - Id: m1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/ApplicationELB
              MetricName: HTTPCode_Target_5XX_Count
              Dimensions:
                - Name: LoadBalancer
                  Value: !GetAtt PrivateLoadBalancer.LoadBalancerFullName
            Period: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, tg500ErrorWindow ]
            Stat: Sum

  LambdaInvocationsOutOfSync:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub LambdaInvocationsOutOfSync-${Environment}
      ActionsEnabled: False
      EvaluationPeriods: 6
      DatapointsToAlarm: 6
      Threshold: 0
      ComparisonOperator: LessThanThreshold
      TreatMissingData: notBreaching
      Metrics:
        - Id: r1
          Label: LambdasOutOfSync
          ReturnData: true
          Expression: c1 + c2 + c3 + c4 + c5
        - Id: c1
          Label: IdentitiesBuiltPerSessionStart
          ReturnData: false
          Expression: IF(l1 > 0 && l2 > 0, IF(l1/l2 > 0.2, 0, -1), 0) # l1 +20% of l2
        - Id: c2
          Label: OAuthResponseBuiltPerIdentitiesBuilt
          ReturnData: false
          Expression: IF(l3 - l1 > 3, -1, IF(l1 - l3 > 3, -1, 0)) # l1 and l3 +- 3
        - Id: c3
          Label: OAuthResponseBuiltPerClientAccessTokensIssued
          ReturnData: false
          Expression: IF(l3 - l4 > 3, -1, IF(l4 - l3 > 3, -1, 0)) # l3 and l4 +- 3
        - Id: c4
          Label: CriOAuthResponseBuiltPerCriSelected
          ReturnData: false
          Expression: IF(l6 > 0 && l5 > 0, IF( l6/l5 < 0.8, -1, IF( l5/l6 < 0.8, -1, 0)), 0) # l6 and l5 +-20%
        - Id: c5
          Label: InitialiseIPVSessionPerCheckExistingIdentity
          ReturnData: false
          Expression: IF( l2 > 0 && l7 > 0, IF( l2/l7 < 0.8, -1, IF( l7/l2 < 0.8, -1, 0)), 0) # l2 and l7 +- 20%
        - Id: l1
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Invocations
              Dimensions:
                - Name: FunctionName
                  Value: !Sub build-user-identity-${Environment}
            Period: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lambdaInvokeCompareWindow ]
            Stat: Sum
        - Id: l2
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Invocations
              Dimensions:
                - Name: FunctionName
                  Value: !Sub initialise-ipv-session-${Environment}
            Period: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lambdaInvokeCompareWindow ]
            Stat: Sum
        - Id: l3
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Invocations
              Dimensions:
                - Name: FunctionName
                  Value: !Sub build-client-oauth-response-${Environment}
            Period: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lambdaInvokeCompareWindow ]
            Stat: Sum
        - Id: l4
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Invocations
              Dimensions:
                - Name: FunctionName
                  Value: !Sub issue-client-access-token-${Environment}
            Period: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lambdaInvokeCompareWindow ]
            Stat: Sum
        - Id: l5
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Invocations
              Dimensions:
                - Name: FunctionName
                  Value: !Sub select-cri-${Environment}
            Period: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lambdaInvokeCompareWindow ]
            Stat: Sum
        - Id: l6
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Invocations
              Dimensions:
                - Name: FunctionName
                  Value: !Sub build-cri-oauth-request-${Environment}
            Period: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lambdaInvokeCompareWindow ]
            Stat: Sum
        - Id: l7
          ReturnData: false
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Invocations
              Dimensions:
                - Name: FunctionName
                  Value: !Sub check-existing-identity-${Environment}
            Period: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lambdaInvokeCompareWindow ]
            Stat: Sum

  ECSBlueGreenDeploymentStack:
    Type: AWS::CloudFormation::Stack
    Condition: UseCanaryDeployment
    Properties:
      TemplateURL: "https://template-storage-templatebucket-1upzyw6v9cs42.s3.amazonaws.com/ecs-canary-deployment/template.yaml"
      Parameters:
        ECSClusterName: !Ref CoreFrontCluster
        ECSServiceName: !GetAtt CoreFrontService.Name
        TargetGroupName: !GetAtt PrivateLoadBalancerListenerTargetGroupECS.TargetGroupName
        LoadBalancerListenerARN: !Ref PrivateLoadBalancerListener
        LoadBalancerFullName: !GetAtt PrivateLoadBalancer.LoadBalancerFullName
        ECSServiceTaskDefinition: !Ref ECSServiceTaskDefinition
        DeploymentStrategy: !Ref DeploymentStrategy
        VpcId: !Sub ${VpcStackName}-VpcId
        ContainerName: app
        ContainerPort: 8080
        ELB4XXAlarmThreshold: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lb400ErrorLimit ]
        ELB5XXAlarmThreshold: !FindInMap [ EnvironmentConfiguration, !Ref AWS::AccountId, lb500ErrorLimit ]
        PermissionsBoundary: !If
          - UsePermissionsBoundary
          - !Ref PermissionsBoundary
          - none
        CodeSigningConfigArn: !If
          - UseCodeSigning
          - !Ref CodeSigningConfigArn
          - !Ref AWS::NoValue

Outputs:
  CoreFrontUrl:
    Description: >-
      The API Gateway URL which Core Front can be invoked on.
    Value: !GetAtt ApiGwHttpEndpoint.ApiEndpoint
  IPVCoreFrontGatewayID:
    Description: Core Front API Gateway ID
    Export:
      Name: !Sub "${AWS::StackName}-IPVCoreFrontGatewayID"
    Value: !Ref ApiGwHttpEndpoint
  IPVCoreFrontRestGatewayID:
    Condition: IsNotDevelopment
    Description: Core Front Rest API Gateway ID
    Export:
      Name: !Sub "${AWS::StackName}-IPVCoreFrontRestGatewayID"
    Value: !Ref RestApiGateway
  IPVCoreFrontRestGatewayStage:
    Condition: IsNotDevelopment
    Description: Core Front Rest API Gateway Stage
    Export:
      Name: !Sub "${AWS::StackName}-IPVCoreFrontRestGatewayStage"
    Value: !Ref ApiGatewayStage
