{% extends "shared/base.njk" %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/details/macro.njk" import govukDetails %}

{% set pageTitleKey = 'pages.sorryTechnicalProblem.title' %}
{% set googleTagManagerPageId = "sorryTechnicalProblem" %}

{% set errorState = pageErrorState %}
{% set errorTitle = 'pages.sorryTechnicalProblem.content.formErrorMessage.title' | translate %}
{% set errorText = 'pages.sorryTechnicalProblem.content.formErrorMessage.description' | translate %}
{% set errorHref = "#sorryTechnicalProblem" %}

{% set isPageDataSensitive = false %}

{% if context %}
    {% if context == 'dlOrPassportMitigation' %}
        {% set contentID = 'cdc6ceca-ee12-47b0-a23f-e666ee9e1481'%}
    {% elif context == 'f2fCriError' %}
        {% set contentID = '8cf31c12-da4b-4eb4-a6e3-fbf966fa520f'%}
    {% elif context == 'kbvCriError' %}
        {% set contentID = 'f676cbc4-5bbf-4d8f-b2da-731d11bc7350'%}
    {% elif context == 'kbvMitigation' %}
        {% set contentID = 'f3f2b9da-c0d5-421a-bf18-6c9726b517e7'%}
    {% endif %}
{% else %}
    {% set contentID = '63d579be-6e27-4bbb-84c3-491228e0a4e9'%}
{% endif %}

{% set whatsNeededToUseTheApp %}
    <p class="govuk-body">{{ 'pages.sorryTechnicalProblem.content.details.p1' | translate }}</p>
    <p class="govuk-body">{{ 'pages.sorryTechnicalProblem.content.details.p2' | translate }}</p>
    <ul class="govuk-list govuk-list--bullet">
      {% for listItem in 'pages.sorryTechnicalProblem.content.details.iphoneTypes' | translate({ returnObjects: true }) %}
        <li>{{ listItem }}</li>
      {% endfor %}
    </ul>
    <p class="govuk-body">{{ 'pages.sorryTechnicalProblem.content.details.p3' | translate }}</p>
    <p class="govuk-body">{{ 'pages.sorryTechnicalProblem.content.details.p4' | translate }}</p>
{% endset %}

{% block content %}
    <h1 class="govuk-heading-l" id="header" data-page="{{ googleTagManagerPageId }}">{{ 'pages.sorryTechnicalProblem.header' | translate }}</h1>
    <p class="govuk-body">{{ 'pages.sorryTechnicalProblem.content.p1' | translate }}</p>

    <h2 class="govuk-heading-m">{{ 'pages.sorryTechnicalProblem.content.subHeading1' | translate }}</h2>
    <p class="govuk-body">{{ 'pages.sorryTechnicalProblem.content.p2' | translate }}</p>

    {% if context != "dlOrPassportMitigation" %}
        <p class="govuk-body">{{ 'pages.sorryTechnicalProblem.content.p3' | translate }}</p>

        {{ govukDetails({
            summaryText: 'pages.sorryTechnicalProblem.content.details.title' | translate,
            html: whatsNeededToUseTheApp,
            id: 'whatsNeededToUseTheApp'
        }) }}

        {% if context != "kbvMitigation" %}
            <p class="govuk-body">{{ 'pages.sorryTechnicalProblem.content.p4' | translateWithContext(context) }}</p>
        {% endif %}

    {% endif %}

    <form id="sorryTechnicalProblem" action="/ipv/page/{{ pageId }}" method="POST">
        <input type="hidden" name="_csrf" value="{{ csrfToken }}">
        {% set initialRadioOptions = [
            {
                value: "tryAgain",
                text: 'pages.sorryTechnicalProblem.content.formRadioButtons.tryAgain' | translate
            }
        ] %}

        {% if context != 'dlOrPassportMitigation' %}
            {% set initialRadioOptions = initialRadioOptions.concat([
                {
                    value: "app",
                    text: 'pages.sorryTechnicalProblem.content.formRadioButtons.app' | translate,
                    hint: { text: 'pages.sorryTechnicalProblem.content.formRadioButtons.appHint' | translate }
                }
            ]) %}
        {% endif %}

        {% if context %}
            {% if context == 'kbvMitigation' %}
                {% set initialRadioOptions = initialRadioOptions.concat([{
                    divider: "or"
                }]) %}
            {% elif context == 'f2fCriError' %}
                {% set initialRadioOptions = initialRadioOptions.concat([
                {
                    value: "webRoute",
                    text: 'pages.sorryTechnicalProblem.content.formRadioButtons.webRoute' | translate,
                    hint: { text: 'pages.sorryTechnicalProblem.content.formRadioButtons.webRouteHint' | translate }
                },
                {
                    divider: "or"
                }]) %}
            {% elif context == "kbvCriError" %}
                {% set initialRadioOptions = initialRadioOptions.concat([
                {
                    value: "postOffice",
                    text: 'pages.sorryTechnicalProblem.content.formRadioButtons.postOffice' | translate,
                    hint: { text: 'pages.sorryTechnicalProblem.content.formRadioButtons.postOfficeHint' | translateWithContext(context) }
                },
                {
                    divider: "or"
                }]) %}
            {% endif %}
        {% else %}
            {% set initialRadioOptions = initialRadioOptions.concat([
            {
                value: "postOffice",
                text: 'pages.sorryTechnicalProblem.content.formRadioButtons.postOffice' | translate,
                hint: { text: 'pages.sorryTechnicalProblem.content.formRadioButtons.postOfficeHint' | translateWithContext(context) }
            },
            {
                divider: "or"
            }]) %}
        {% endif %}

        {% set finalRadioOptions = [
             {
                 value: "returnToRp",
                 text: 'pages.sorryTechnicalProblem.content.formRadioButtons.returnToRp' | translate
             }]
        %}

        {% set radiosConfig = {
            idPrefix: "journey",
            name: "journey",
            fieldset: {
                legend: {
                    text: 'pages.sorryTechnicalProblem.content.subHeading2' | translate,
                    classes: "govuk-fieldset__legend--m"
                }
            },
            items: initialRadioOptions.concat(finalRadioOptions)
        } %}

        {% if errorState %}
          {% set errorMessageObject = { 'text': 'pages.sorryTechnicalProblem.content.formErrorMessage.errorRadioMessage' | translate } %}
          {% set radiosConfig = radiosConfig | setAttribute('errorMessage', errorMessageObject) %}
        {% endif %}

        {{ govukRadios(radiosConfig) }}
        {{ govukButton({
          id: "submitButton",
          text: 'general.buttons.next' | translate
        }) }}
    </form>

    {% include "components/contact-us-link.njk" %}
{% endblock %}
